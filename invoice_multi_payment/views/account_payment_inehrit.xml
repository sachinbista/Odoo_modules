<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <data>
        <record model="ir.ui.view" id="account_payment_form_inherit_imp">
            <field name="name">account.payment.imp.form</field>
            <field name="model">account.payment</field>
            <field name="inherit_id" ref="account.view_account_payment_form"/>
            <field name="arch" type="xml">
                <xpath expr="//group[@name='group2']" position="inside">
                    <field name="payment_allocation" invisible="1"/>
                    <field name="total_amount" string="Total Payment"
                           attrs="{'invisible': ['|',('state', 'in', ['draft', 'cancel']),('payment_allocation', '!=', True)]}"/>
                    <field name="payment_outstanding_amount" string="Remaining Amount"
                           attrs="{'invisible': ['|',('state', 'in', ['draft', 'cancel']),('payment_allocation', '!=', True)]}"/>
                    <field name="remaining_amount" invisible="1"/>
                    <field name="carry_forward_paid" invisible="1"/>
                    <field name="check_all_posted" invisible="1"/>
                    <field name="discount_amount"
                           attrs="{'invisible': ['|',('state', 'in', ['draft', 'cancel']),('payment_allocation', '!=', True)]}"/>
                    <field name="sale_tax" invisible="1"/>
                    <field name="writeoff_amount"
                           attrs="{'invisible': ['|',('state', 'in', ['draft', 'cancel']),('payment_allocation', '!=', True)]}"/>
                    <field name="discount_account_id" invisible="1"/>
                    <field name="sale_tax_account_id" invisible="1"/>
                    <field name="writeoff_account_id" invisible="1"/>
                    <field name="is_hide_allocation" invisible="1"/>
                </xpath>

                <!--                <xpath expr="//header/button[@name='action_draft']" position="after">-->
                <!--                    <button name="action_process_payment_allocation"-->
                <!--                            string="Process Payment Allocation"-->
                <!--                            type="object" class="btn-primary"-->
                <!--                            attrs="{'invisible':['|',('is_hide_allocation', '=', True),('state', '!=', 'posted')]}"-->
                <!--                            style="float:right;"-->
                <!--                            groups="account.group_account_manager" invisible="1"/>-->
                <!--                </xpath>-->
                <xpath expr="//group" position="after">
                    <notebook>
                        <page string="Outstanding &amp; Invoice Lines" name="invoice_lines_page"
                              invisible="1"
                              attrs="{'invisible': [('is_hide_allocation' , '=', True),('invoice_lines', '=', [])]}">
                            <separator string="Invoice / Bills"/>
                            <!--attrs="{'invisible':[('payment_type', '=', 'outbound')]}"-->
                            <field name="select_all" invisible="1"/>
                            <button name="update_invoice_lines"
                                    string="Update Invoices"
                                    type="object" class="btn-primary"
                                    attrs="{'invisible':[('is_hide_allocation', '=', True)]}"
                                    style="float:left"/>
                            <text>
                                <![CDATA[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]></text>
                            <button name="update_amounts"
                                    type="object" icon="fa-refresh" string="Update Amounts"
                                    attrs="{'invisible':[('is_hide_allocation', '=', True)]}"
                                    help="Refresh all amount due and outstanding"
                            />
                            <text>
                                <![CDATA[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]></text>
                            <button name="clear_selection"
                                    type="object" string="Clear"
                                    attrs="{'invisible':[('is_hide_allocation', '=', True)]}"
                                    help="Clear all selection and clear all discount, sale tax and allocation"
                            />
                            <button name="select_all_invoice"
                                    string="Allocate Amt"
                                    type="object" class="btn-primary pull-right"
                                    attrs="{'invisible':['|',('is_hide_allocation', '=', True),('select_all', '=', True)]}"
                            />
                            <button name="deselect_all_invoce"
                                    string="De-allocate Amt"
                                    type="object" class="btn-primary pull-right"
                                    attrs="{'invisible':['|',('is_hide_allocation', '=', True),('select_all', '=', False)]}"
                                    help="De-allocate allocated amount"
                            />
                            <text class="pull-right">
                                <![CDATA[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]></text>

                            <field name="is_utilize" widget="boolean_toggle"
                                   attrs="{'readonly':[('is_hide_allocation', '=', True)]}"
                                   class="pull-right"/>
                            <label class="pull-right" for="is_utilize" string="Utilize Outstanding"/>

                            <field name="invoice_lines" attrs="{'readonly':[('check_all_posted', '=', True)]}"
                                   context="{'order': id}">

                                <tree create="false" editable="bottom" js_class="lazy_column_list"
                                      delete="false">
                                    <field name="id" invisible="1"/>
                                    <field name="select" widget="boolean_toggle"
                                           attrs="{'readonly':[('parent.check_all_posted', '=', True)]}"/>
                                    <field name="invoice_id" readonly="1"/>
                                    <field name="move_line_ids" widget="many2many_tags" readonly="1" optional="hide"/>
                                    <field name="move_line_id" invisible="1"/>
                                    <field name="invoice" readonly="1" invisible="1"/>
                                    <field name="invoice_date" optional="hide" readonly="1"/>
                                    <field name="payment_date" optional="show" readonly="1"/>
                                    <field name="total_amount" readonly="True" sum="Total Amount" optional="hide"/>
                                    <field name="open_amount" readonly="True" sum="Due Amount"/>
                                    <field name="currency_id" invisible="1"/>
                                    <field name="invoice_currency_id" invisible="1"/>
                                    <field name="converted_currency_amount" sum="Due Amount in Currency" invisible="1"/>
                                    <field name="amount_allowed_discount" readonly="1" sum="Allowed Discount"/>
                                    <field name="discount_amount" sum="Discount Amount in Currency"/>
                                    <field name="sale_tax" sum="Total Sale Tax" invisible="1" readonly="1"/>
                                    <field name="allocation" sum="Allocated Amount" readonly="0" force_save="1"/>
                                    <field name="payment_difference" force_save="1" readonly="1"
                                           sum="Payment Difference"/>
                                    <field name="select_all" widget="boolean_toggle"
                                           attrs="{'readonly':[('parent.check_all_posted', '=', True)], 'invisible': [('payment_difference', '=', 0.0)]}"/>
                                </tree>
                                <form string="Invoice" create="false">
                                    <group>
                                        <group>
                                            <field name="invoice_id"/>
                                            <field name="move_line_ids" readonly="1"/>
                                            <field name="invoice" invisible="1"/>
                                            <field name="move_line_id" invisible="1"/>
                                            <field name="date" readonly="True" string='Invoice Date'/>
                                            <field name="payment_date" readonly="True"/>
                                            <field name="total_amount" readonly="True"/>
                                            <field name="open_amount" readonly="True"/>
                                        </group>
                                        <group>
                                            <field name="discount_amount"/>
                                            <field name="sale_tax" invisible="1"/>
                                            <field name="allocation" widget="monetary"/>
                                            <field name="payment_difference" force_save="1" readonly="1"/>
                                            <field name="select_all" widget="boolean_toggle" readonly="1"
                                                   force_save="1"/>
                                        </group>

                                    </group>
                                </form>
                            </field>

                            <separator string="Outstanding / Credit"/>
                            <field name="outstanding_payment_ids"
                                   attrs="{'readonly':[('check_all_posted', '=', True)]}">
                                <tree create="false" editable="bottom" decoration-warning="move_id != False"
                                      delete="false">
                                    <field name="reference" readonly="1" invisible="1"/>
                                    <field name="source_id" readonly="1"/>
                                    <field name="move_payment_id" readonly="1" force_save="1"
                                           optional="hide"/>
                                    <field name="move_id" readonly="1" force_save="1" optional="hide"/>
                                    <field name="move_line_id" readonly="1" force_save="1" invisible="1"/>
                                    <field name="payment_date" readonly="1" force_save="1"/>
                                    <field name="amount_residual" readonly="1" force_save="1" sum="Total Outstanding"/>
                                    <field name="amount_to_utilize" force_save="1" sum="Amount to Utilize"/>
                                </tree>
                                <form>
                                    <group>
                                        <group>
                                            <field name="source_id"/>
                                            <field name="move_payment_id" readonly="1" force_save="1"
                                                   invisible="1"/>
                                            <field name="move_id" readonly="1" force_save="1"
                                                   invisible="1"/>
                                            <field name="payment_date" readonly="1" force_save="1"/>
                                            <field name="move_line_id" readonly="1" force_save="1" invisible="1"/>
                                        </group>
                                        <group>
                                            <field name="amount_residual" readonly="1" force_save="1"/>
                                            <field name="amount_to_utilize" readonly="1" force_save="1"/>
                                        </group>
                                    </group>
                                </form>
                            </field>

                        </page>
                    </notebook>
                </xpath>
                <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                    <button class="oe_stat_button" name="action_open_common_view"
                            string="Payment Allocation"
                            type="object"
                            icon="fa-money"
                            attrs="{'invisible': ['|',('state', 'in', ['draft', 'cancel']),('payment_allocation', '!=', True)]}"/>
                    <button class="oe_stat_button" name="action_open_carry_forward_moves"
                            string="Carry-Forward Moves"
                            type="object"
                            icon="fa-money"
                            attrs="{'invisible': [('carry_forward_count', '=', 0)]}">
                    </button>
                    <field name="carry_forward_count" invisible="1"/>
                </xpath>
            </field>
        </record>

        <record id="view_account_payment_tree_outstanding" model="ir.ui.view">
            <field name="name">account.payment.tree.outstanding</field>
            <field name="model">account.payment</field>
            <field name="inherit_id" ref="account.view_account_payment_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='state']" position="after">
                    <field name="payment_outstanding_amount" sum="Outstanding Amount" optional="show"/>
                </xpath>
                <xpath expr="//field[@name='name']" position="after">
                    <field name="ref" sum="Reference"/>
                </xpath>
            </field>
        </record>


        <record id="account.action_account_payments" model="ir.actions.act_window">
            <field name="name">Payments</field>
            <field name="res_model">account.payment</field>
            <field name="view_mode">tree,kanban,form,graph</field>
            <field name="context">{
                'default_payment_type': 'inbound',
                'default_partner_type': 'customer',
                'search_default_inbound_filter': 1,
                'default_move_journal_types': ('bank', 'cash'),
                'default_payment_allocation': True,
                }
            </field>
            <field name="view_id" ref="account.view_account_payment_tree"/>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Register a payment
                </p>
                <p>
                    Payments are used to register liquidity movements. You can process those payments by your own means
                    or by using installed facilities.
                </p>
            </field>
        </record>
    </data>
</odoo>
