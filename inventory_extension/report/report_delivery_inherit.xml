<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="stock_report_delivery_has_serial_move_line_inherits"
              inherit_id="stock.stock_report_delivery_has_serial_move_line">
        <xpath expr="//td" position="attributes">
            <attribute name="style">border:1px solid black;</attribute>
        </xpath>
    </template>

    <template id="report_delivery_document_inherits" inherit_id="stock.report_delivery_document">
        <xpath expr="//table[@name='stock_move_line_table']/thead" position="attributes">
            <attribute name="style">border:1px solid black;</attribute>
        </xpath>
        <xpath expr="//table[@name='stock_move_line_table']/thead/tr/th" position="attributes">
            <attribute name="style">border:1px solid black;</attribute>
        </xpath>
        <xpath expr="//table[@name='stock_move_line_table']/tbody" position="attributes">
            <attribute name="style">border:1px solid black;</attribute>
        </xpath>
        <xpath expr="//table[@name='stock_move_line_table']/thead/tr/th[@name='th_sml_quantity']" position="attributes">
            <attribute name="style">border:1px solid black;</attribute>
        </xpath>
        <xpath expr="//table[@name='stock_move_line_table']/thead/tr/th[@name='th_sml_product']" position="replace">
            <!--            <tr style="border:1px solid black;">-->
            <t t-set="packages" t-value="o.move_line_ids.mapped('result_package_id')"/>
            <t t-if="packages">
                <th style="border:1px solid black;">
                    <strong>Pack</strong>
                </th>
            </t>
            <t t-else="packages">
                <th style="border:1px solid black;">
                    <strong>Product</strong>
                </th>
            </t>

        </xpath>
        <xpath expr="//table[@name='stock_move_line_table']/thead/tr/th[@name='th_sml_qty_ordered']" position="replace">
            <t t-set="packages" t-value="o.move_line_ids.mapped('result_package_id')"/>
            <t t-if="packages">
                <th name="th_sm_product" style="border:1px solid black;">
                    <strong>Qty</strong>
                </th>
            </t>
            <t t-else="">
                <th name="th_sml_qty_ordered" class="text-center" style="border:1px solid black;"
                    t-if="not has_serial_number">
                    <strong>Ordered</strong>
                </th>
            </t>

        </xpath>
        <xpath expr="//table[@name='stock_move_line_table']/thead/tr/th[@name='lot_serial']" position="replace">
            <t t-set="packages" t-value="o.move_line_ids.mapped('result_package_id')"/>
            <t t-if="packages">
                <th name="th_sm_product" style="border:1px solid black;">
                    <strong>Item Number</strong>
                </th>
            </t>
            <t t-elif="" style="border:1px solid black;">
                <th name="lot_serial">
                    Lot/Serial Number
                </th>
            </t>
        </xpath>
        <xpath expr="//table[@name='stock_move_line_table']/thead/tr/th[@name='th_sml_quantity']" position="replace">
            <t t-set="packages" t-value="o.move_line_ids.mapped('result_package_id')"/>
            <t t-if="packages">
                <th name="th_sm_product" style="border:1px solid black;">
                    <strong>Item Description</strong>
                </th>
            </t>
            <t t-else="">
                <th name="th_sml_quantity" class="text-center" style="border:1px solid black;">
                    <strong>Delivered</strong>
                </th>

            </t>
        </xpath>


        <xpath expr="//table[@name='stock_move_line_table']/tbody/t[@name='has_packages']/t[@t-set='packages']"
               position="after">
            <t t-set="packages" t-value="packages.sorted(key=lambda m: m.id, reverse=False)"/>
        </xpath>
        <!--        <xpath expr="//table[@name='stock_move_line_table']/tbody/t[@name='has_packages']/t[@t-foreach='packages']" position="replace">-->
        <xpath expr="//table[@name='stock_move_line_table']/tbody/t[@name='has_packages']/t[@t-foreach='packages']"
               position="replace">
            <t t-set="printed_pack_numbers" t-value="[]"/>
            <t t-foreach="packages" t-as="package">
                <!--<t t-call="stock.stock_report_delivery_package_section_line"/>  Call to display package section line &ndash;&gt;-->
                <t t-set="package_move_lines"
                   t-value="o.move_line_ids.filtered(lambda l: l.result_package_id == package)"/>
                <t t-foreach="package_move_lines" t-as="move_line">
                    <tr>
                        <!--                        <t t-if="package">-->
                        <td style="border:1px solid black;" class="text-center">
                            <!--                        <t t-call="stock.stock_report_delivery_package_section_line"/>Call to display package section line-->
                            <!--                            <t t-foreach="package_ids" t-as="package">-->
                            <t t-if="package.pack_count not in printed_pack_numbers">
                                <t t-set="printed_pack_numbers"
                                   t-value="printed_pack_numbers + [package.pack_count]"/>

                                <span t-field="package.pack_count"/>

                            </t>
                            <!--                            </t>-->
                            <td class="text-center" style="border:1px solid black;">
                                <span t-field="move_line.quantity"/>
                                <span t-field="move_line.product_uom_id"/>

                            </td>
                            <td style="border:1px solid black;" class="text-start">
                                <span t-field="move_line.product_id.default_code"/>
                            </td>
                            <td style="border:1px solid black;" class="text-start">
                                <span t-field="move_line.product_id.name"/>
                            </td>

                        </td>
                        <!--                        </t>-->
                    </tr>
                </t>
            </t>
        </xpath>
        <xpath expr="//t[@name='no_package_move_lines']//t[@t-if='has_serial_number']" position="replace">
            <t t-if="has_serial_number">
                <tr t-foreach="move_lines" t-as="move_line">

                </tr>
            </t>
        </xpath>

        <xpath expr="//t[@name='no_package_move_lines']//t[@t-elif='aggregated_lines']" position="replace">
            <t t-elif="aggregated_lines">
                <t t-call="inventory_extension.stock_delievery_move_line"/>
            </t>
        </xpath>

    </template>

    <template id="stock_delievery_move_line">
        <tr t-foreach="aggregated_lines" t-as="line">
            <td style="border:1px solid black;">
                <t t-if="package.pack_count not in printed_pack_numbers">
                    <t t-set="printed_pack_numbers"
                       t-value="printed_pack_numbers + [package.pack_count]"/>
                    <span t-field="package.pack_count"/>
                </t>
            </td>

            <td class="text-center" name="move_line_aggregated_qty_ordered" style="border:1px solid black;">
                <span t-esc="aggregated_lines[line]['qty_ordered']"
                      t-options="{'widget': 'float', 'decimal_precision': 'Product Unit of Measure'}"/>
                <span t-esc="aggregated_lines[line]['product_uom'].name"/>
                <span t-if="aggregated_lines[line]['packaging'].name">
                    (
                    <span t-out="aggregated_lines[line]['packaging_qty']" t-options='{"widget": "integer"}'/>
                    <span t-out="aggregated_lines[line]['packaging'].name"/>)
                </span>
            </td>
            <td style="border:1px solid black;">
                <p t-if="aggregated_lines[line]['product']">
                    <span t-esc="aggregated_lines[line]['product'].default_code"/>
                </p>
            </td>
            <td style="border:1px solid black;">
                <p t-if="aggregated_lines[line]['product']">
                    <span t-esc="aggregated_lines[line]['product'].name"/>
                </p>
            </td>
        </tr>
    </template>
</odoo>