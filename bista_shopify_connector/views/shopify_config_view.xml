<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="view_shopify_config_form" model='ir.ui.view'>
            <field name="name">view.shopify.config.form</field>
            <field name="model">shopify.config</field>
            <field name="arch" type="xml">
                <form name="shopify_config">
                    <header>
                        <button name="check_connection_button" type="object"
                                class="oe_highlight" string="Check Connection"
                                groups="bista_shopify_connector.group_shopify_admin"
                                invisible="not active"/>
                        <button name="reset_to_draft" type="object"
                                class="oe_highlight" string="Set to Draft"
                                invisible="state == 'draft'"/>
                                confirm="Are you sure you want to set to draft?"
                                groups="bista_shopify_connector.group_shopify_admin"/>
                        <field name="state" widget="statusbar"
                               statusbar_visible="draft,success,fail"/>
                    </header>
                    <sheet>
                        <field name="active" invisible="1"/>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_shopify_customer" type="object"
                                    groups="bista_shopify_connector.group_shopify_admin"
                                    icon="fa-user" class="oe_stat_button"
                                    invisible="shopify_customer_count &lt;= 0">
                                <field string="Customers" name="shopify_customer_count"
                                       widget="statinfo"/>
                            </button>
                            <button name="action_shopify_product"
                                    type="object"
                                    icon="fa-product-hunt" class="oe_stat_button"
                                    invisible="shopify_product_count &lt;= 0">
                                <field string="Product" name="shopify_product_count"
                                       widget="statinfo"/>
                            </button>
                            <button name="action_shopify_order"
                                    type="object"
                                    icon="fa-usd" class="oe_stat_button"
                                    invisible="shopify_order_count &lt;= 0">
                                <field string="Orders" name="shopify_order_count"
                                       widget="statinfo"/>
                            </button>
                            <button name="action_shopify_invoice"
                                    type="object"
                                    icon="fa-pencil-square-o" class="oe_stat_button"
                                    invisible="shopify_invoice_count &lt;= 0">
                                <field string="Invoice" name="shopify_invoice_count"
                                       widget="statinfo"/>
                            </button>
                            <button name="action_shopify_credit_note"
                                    type="object"
                                    icon="fa-credit-card" class="oe_stat_button"
                                    invisible="shopify_credit_note_count &lt;= 0">
                                <field string="Credit Note" name="shopify_credit_note_count"
                                       widget="statinfo"/>
                            </button>
                            <button name="action_shopify_delivery"
                                    type="object"
                                    icon="fa-shopping-cart" class="oe_stat_button"
                                    invisible="shopify_delivery_count &lt;= 0">
                                <field string="Shipment" name="shopify_delivery_count"
                                       widget="statinfo"/>
                            </button>
                            <button type="object" name="action_shopify_queue_operations"
                                    class="oe_stat_button" icon="fa-tasks"
                                    groups="bista_shopify_connector.group_shopify_admin"
                                    invisible="not active">
                                <span class="o_stat_text">Queue</span>
                            </button>
                            <button type="object" name="action_shopify_log_operations"
                                    class="oe_stat_button" icon="fa-history"
                                    groups="bista_shopify_connector.group_shopify_admin"
                                    invisible="not active">
                                <span class="o_stat_text">Error log</span>
                            </button>
                            <button type="object" name="action_active_locations"
                                    class="oe_stat_button" icon="fa-location-arrow"
                                    groups="bista_shopify_connector.group_shopify_admin"
                                    invisible="not active">
                                <span class="o_stat_text">Locations</span>
                            </button>
                            <button type="object" name="schedulers_configuration_action"
                                    class="oe_stat_button" icon="fa-wrench"
                                    groups="bista_shopify_connector.group_shopify_admin"
                                    invisible="not active">
                                <span class="o_stat_text">Schedulers</span>
                            </button>
                            <button type="object" name="action_active_schedulers"
                                    class="oe_stat_button" icon="fa-play-circle"
                                    groups="bista_shopify_connector.group_shopify_admin"
                                    invisible="not active">
                                <span class="o_stat_text">Active Schedulers</span>
                            </button>
                            <button class="oe_stat_button"
                                    name="shopify_archive_active" icon="fa-bell"
                                    type="object"
                                    invisible="not active">
                                <span class="o_stat_text" style="color:#5fdba7">Active</span>
                            </button>
                            <button class="oe_stat_button"
                                    name="shopify_archive_active" icon="fa-bell-slash"
                                    type="object"
                                    invisible="active">
                                <span class="o_stat_text" style="color:#e2d0a8">Archived</span>
                            </button>
                        </div>
                        <label for="name" class="oe_edit_only"/>
                        <h1>
                            <field name="name" class="oe_inline"
                                   readonly="state == 'success'"/>
                        </h1>
                        <group name="shopify_credentials" string="Shopify Credentials">
                            <group colspan="4" col="4">
                                <field name="shop_url"
                                       placeholder="e.g. https://my-shop.myshopify.com"
                                       readonly="state == 'success'"/>
                                <field name="api_key"
                                       readonly="state == 'success'"/>
                                <field name="password" password="1"
                                       readonly="state == 'success'"/>
                                <field name="default_company_id"
                                       options="{'no_create': True, 'no_create_edit': True, 'no_open': True}"
                                       readonly="state == 'success'"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Workflow" name="shopify_workflow"
                                  invisible ="state != 'success'">
                                <!-- <field name="workflow_line_ids">
                                    <tree name="Shopify Workflow Lines" editable="bottom">
                                         <field name="pay_gateway_id"/>
                                         <field name="auto_workflow_id"/>
                                         <field name="financial_workflow_id"/>
                                    </tree>
                                </field> -->
                                 <field name="financial_workflow_ids">
                                    <tree string="Shopify Financial Workflow" editable="bottom">
                                         <field name="name" readonly="1"/>
                                         <field name="company_id" invisible="1"/>
                                        <field name="auto_workflow_id" required="1" domain="[('company_id', '=', parent.default_company_id)]" options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="payment_gateway_id" required="1" options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="payment_term_id" required="1" options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="financial_status" required="1"/>
                                    </tree>
                                </field>
                            </page>
                            <page string="Common Configuration" name="common_config"
                                  invisible ="state != 'success'">
                                <group>
                                    <group>
                                        <field name="shopify_order_prefix" invisible="1"/>
                                        <field name="sale_team_id" required ="state == 'success'" options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="shipping_product_id" required ="state == 'success'" options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="warehouse_id" required ="state == 'success'" options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="is_create_customer"  widget="boolean_toggle"/>
                                        <field name="default_customer_id" required ="state == 'success'" options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="sync_product" widget="radio"/>
                                        <field name="product_categ_id" required ="state == 'success'" options="{'no_create': True, 'no_create_edit': True}"/>
                                    </group>
                                    <group>
                                        <field name="is_create_product" widget="boolean_toggle"/>
                                        <field name="sync_inventory_on_reservation" widget="boolean_toggle"/>
                                        <field name="shopify_product_id" invisible ="is_create_product" required ="not is_create_product" options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="invoicing_policy" invisible = "not is_create_product"/>
                                        <field name="is_sync_product_image"
                                               widget="boolean_toggle"/>
                                        <!-- <field name="is_validate_inv_adj" widget="boolean_toggle"/> -->
                                        <field name="is_refund_auto_paid" widget="boolean_toggle" />
                                        <field name="is_use_shop_seq" widget="boolean_toggle"/>
                                        <field name="is_risk_order" widget="boolean_toggle"/>
                                        <field name="is_auto_invoice_paid" widget="boolean_toggle"/>
                                        <field name="is_auto_archive" widget="boolean_toggle" invisible="1"/>
                                    </group>
                                </group>
                            </page>

                            <page string="Account Configuration" name="default_config">
                                <group>
                                    <group>
                                        <field name="analytic_account_id"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               required="1"
                                               options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="pricelist_id" required="1"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="default_rec_account_id"
                                               required="1"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="default_pay_account_id"
                                               required="1"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True,}"/>
                                        <!--<field name="credit_note_journal_id" required="1"
                                               attrs="{'readonly': [('state','=','success')]}"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id),
                                               ('type', '=', 'sale')]"
                                               options="{'no_create': True, 'no_create_edit': True,}"/>-->
                                        <!-- TODO: Made invisible as we need to discuss down-payment split workflow for multiple final invoices -->
                                        <field name="is_pay_unearned_revenue" widget="boolean_toggle"/>
                                        <field name="shopify_tag_ids" colspan="2"
                                               invisible = "not is_pay_unearned_revenue" required="is_pay_unearned_revenue"
                                               widget="many2many_tags" options="{'no_create': True, 'no_create_edit': True,}"/>
                                        <field name="unearned_account_id" colspan="2"
                                               invisible = "not is_pay_unearned_revenue" required="is_pay_unearned_revenue"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="rounding_diff_account_id"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True,}"/>
                                    </group>
                                    <group>
                                        <field name="default_payment_term_id" required="1"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>

                                        <field name="fiscal_shopify_id" required="0"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>

                                       <!-- <field name="shopify_bank_journal_id" required="1"
                                                attrs="{'readonly': [('state','=','success')]}"
                                                domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id),
                                                ('type', '=', 'bank')]"
                                                options="{'no_create': True, 'no_create_edit': True}"/>-->
                                        <!-- <field name="default_payment_journal" required="1"
                                                attrs="{'readonly': [('state','=','success')]}"
                                                domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id), ('type', '=', 'bank')]"
                                                options="{'no_create': True, 'no_create_edit': True}"/>
                                         <field name="credit_note_journal_id" required="1"
                                                attrs="{'readonly': [('state','=','success')]}"
                                                domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                                options="{'no_create': True, 'no_create_edit': True}"/>-->
                                        <field name="default_tax_account_id" required="1"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>
                                        <field name="default_tax_cn_account_id" required="1"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>

                                        <!--<field name="stock_location_id" required="0"
                                               attrs="{'readonly': [('state','=','success')]}"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"
                                               invisible="1"/>-->
                                        <field name="default_payment_journal_id" required="1"
                                               readonly="state == 'success'"
                                               domain="['|', ('company_id', '=', False), ('company_id', '=', default_company_id)]"
                                               options="{'no_create': True, 'no_create_edit': True}"/>

                                    </group>
                                </group>
                                <group>
                                    <!-- <field name="payout_ids" nolabel="1">
                                        <tree nolabel="1" editable='bottom'>
                                            <field name="balance_transaction_type" required="1"/>
                                            <field name="account_id" required="1" options="{'no_create':True,'no_create_edit': True}"/>
                                        </tree>
                                    </field> -->
                                </group>
                            </page>
                            <page name="location_mappings" string="Location Mapping" invisible="state != 'success'">
                               <field name="shopify_location_mappings">
                                   <tree string="Shopify Odoo Location Mapping" editable="bottom">
                                       <field name="shopify_location_id" readonly="1"/>
                                       <field name="shopify_location_name" readonly="1"/>
                                       <field name="warehouse_id" required="1"
                                              domain="[('company_id', '=', parent.default_company_id)]"
                                              options="{'no_create': True, 'no_create_edit': True}"/>
                                       <field name="odoo_location_id" required="1"/>
                                   </tree>
                                </field>
                            </page>
                            <page name="webhook" string="Webhooks" invisible="state != 'success'">
                                <button name="configure" type="object" class="oe_left oe_highlight">
                                    <span>
                                        Configure Webhooks
                                        <i class="fa fa-gears"></i>
                                    </span>
                                </button>
                                <button name="webhook_delete" type="object" class="oe_right oe_highlight">
                                    <span>
                                        <i class="fa fa-trash"></i>
                                        Delete Webhooks
                                    </span>
                                </button>
                                <field name="webhook_ids" nolabel="1" context="{'active_test': False}" width="100%">
                                     <tree  decoration-success="active" decoration-muted="not active" create="false" >
                                        <field name="webhook_name" required="1"/>
                                        <field name="webhook_action" required="1"/>
                                        <field name="callback_url" required="1"/>
                                        <field name="active" widget="boolean_toggle"/>
                                    </tree>
                                </field>
                                <div style="padding:45px;" class="alert alert-info" role="alert" width="100%">
                                    <h5 style="color:black;">
                                        <b>
                                            <u>Information Of Retry Frequency:</u>
                                        </b>
                                    </h5>
                                    <b style="color:black;">
                                        <ol>
                                            <li>
                                                As mentioned Shopify has implemented a five-second timeout period and a retry period for webhook subscriptions.
                                            </li>
                                            <li>
                                                Shopify will wait five seconds for a response for each request to a webhook.
                                            </li>
                                             <li>
                                                If there will be no response, or an error is returned, then Shopify retries the connection 19 times over the next 48 hours.
                                            </li>
                                             <li>
                                                If there are 19 consecutive failures, then the webhook subscription is automatically deleted.
                                            </li>
                                            <li>
                                                A warning that the subscription will be deleted is sent to the app's emergency developer email address.
                                            </li>
                                            <li>
                                                To avoid timeouts and errors, consider deferring app processing until after the webhook response has been successfully sent.
                                            </li>
                                            <li>
                                                If the configuration of Shopify is inactivated then the webhooks will be set as "Inactive".
                                            </li>
                                        </ol>
                                    </b>
                                </div>
                            </page>
                            <page string="Sync Date Info" name="sync_date_info"
                                  invisible="1">
                                <group>
                                    <group>
                                        <field name="last_import_customer_date"/>
                                        <field name="last_product_import_date"/>
                                        <field name="last_refund_import_date"/>
                                    </group>
                                    <group>
                                        <field name="last_import_order_date"/>
                                        <field name="last_stock_import_date"/>
                                        <field name="last_return_order_import_date"/>
                                        <field name="last_payout_import_date"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                        <div invisible="state != 'success'">
                            <span>
                                <h3>Support:</h3>
                                <strong>E-mail :</strong> sales@bistasolutions.com<br/>
                                <strong>Website :</strong> https://www.bistasolutions.com
                            </span>
                        </div>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <record id="view_shopify_config_tree" model="ir.ui.view">
            <field name="name">view.shopify.config.tree</field>
            <field name="model">shopify.config</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="name"/>
                    <field name="state"/>
                    <field name="default_company_id"/>
                </tree>
            </field>
        </record>

        <record id="view_shopify_config_search" model="ir.ui.view">
            <field name="name">view.shopify.config.search</field>
            <field name="model">shopify.config</field>
            <field name="arch" type="xml">
                <search>
                    <field name="name"/>
                    <field name="default_company_id"/>
                    <field name="shop_url"/>
                    <field name="api_key"/>
                    <field name="password"/>
                    <filter name="draft" string="Draft" domain="[('state','=','draft')]"/>
                    <filter name="success" string="Success" domain="[('state','=','success')]"/>
                    <filter name="fail" string="Fail" domain="[('state','=','fail')]"/>
                    <group string="Group By">
                        <filter string="State" name="state" context="{'group_by':'state'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="action_shopify_config" model="ir.actions.act_window">
            <field name="name">Shopify Configuration</field>
            <field name="res_model">shopify.config</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="bista_shopify_connector.view_shopify_config_search"/>
        </record>
        <menuitem id="shopify_config_menu" name="Shopify Configuration"
                  parent="shopify_configuration_menu"
                  action="action_shopify_config"
                  groups="bista_shopify_connector.group_shopify_admin"
                  sequence="1"/>
    </data>
</odoo>
